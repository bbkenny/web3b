<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TownPlanPay - Contractor Portal</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #2c5aa0; text-align: center; }
        p { text-align: center; color: #444; }
        .form-group { margin: 20px 0; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input, textarea, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            box-sizing: border-box;
        }
        button { 
            background: #2c5aa0; 
            color: white; 
            padding: 12px 30px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px;
            width: 100%;
        }
        button:hover { background: #1e3d6f; }
        .result { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 5px; 
            display: none;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { display: none; text-align: center; color: #2c5aa0; font-weight: bold; }
        .preview img { width: 100px; margin: 5px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèóÔ∏è TownPlanPay Contractor Portal</h1>
        <p>Submit milestone evidence for AI verification and instant USDC payment.</p>
        
        <form id="milestoneForm">
            <div class="form-group">
                <label for="projectName">Project Name:</label>
                <input type="text" id="projectName" placeholder="e.g., Lagos Road Rehabilitation" required>
            </div>

            <div class="form-group">
                <label for="walletAddress">Contractor Wallet Address:</label>
                <input type="text" id="walletAddress" placeholder="e.g., 0xabc123..." required>
            </div>
            
            <div class="form-group">
                <label for="milestone">Milestone:</label>
                <select id="milestone" required>
                    <option value="">Select Milestone</option>
                    <option value="site_prep">Site Preparation & Mobilization</option>
                    <option value="foundation">Foundation & Drainage Complete</option>
                    <option value="road_base">Road Base Compacted</option>
                    <option value="final_surface">Final Surface & Markings</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="evidencePhotos">Upload Evidence Photos (Multiple):</label>
                <input type="file" id="evidencePhotos" multiple accept="image/*">
                <div class="preview" id="photoPreview"></div>
            </div>
            
            <div class="form-group">
                <label for="gpsCoordinates">GPS Coordinates:</label>
                <input type="text" id="gpsCoordinates" placeholder="e.g., 6.5244¬∞ N, 3.3792¬∞ E" required>
                <button type="button" id="autofillGPS">üìç Autofill GPS</button>
            </div>
            
            <div class="form-group">
                <label for="description">Work Description:</label>
                <textarea id="description" rows="4" placeholder="Describe the completed work..." required></textarea>
            </div>
            
            <button type="submit">Submit for AI Verification</button>
        </form>
        
        <div class="loading" id="loading">
            üîç AI is verifying your submission... Please wait.
        </div>
        
        <div class="result success" id="successResult">
            <h3>‚úÖ Milestone Approved!</h3>
            <p><strong>AI Confidence:</strong> <span id="confidenceScore">92%</span></p>
            <p><strong>Approved Amount:</strong> <span id="approvedAmount">5,000</span> USDC</p>
            <p><strong>Transaction ID:</strong> <span id="transactionId">0x7d9e...c42a</span></p>
            <p>Payment processing initiated. Funds will arrive in your wallet shortly.</p>
        </div>
        
        <div class="result error" id="errorResult">
            <h3>‚ùå Verification Failed</h3>
            <p id="errorMessage">Insufficient evidence provided. Please upload more photos and try again.</p>
        </div>
    </div>

    <script>
        // Autofill GPS using browser location
        document.getElementById('autofillGPS').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(pos) {
                        document.getElementById('gpsCoordinates').value = 
                            pos.coords.latitude.toFixed(6) + ", " + pos.coords.longitude.toFixed(6);
                    },
                    function() {
                        alert('Unable to retrieve GPS location. Please enter manually.');
                    }
                );
            } else {
                alert('Geolocation not supported by this browser.');
            }
        });

        // Image preview
        document.getElementById('evidencePhotos').addEventListener('change', function(e) {
            const previewContainer = document.getElementById('photoPreview');
            previewContainer.innerHTML = '';
            Array.from(e.target.files).forEach(file => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                previewContainer.appendChild(img);
            });
        });

        // Mock AI verification simulation
        document.getElementById('milestoneForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('successResult').style.display = 'none';
            document.getElementById('errorResult').style.display = 'none';
            
            setTimeout(function() {
                document.getElementById('loading').style.display = 'none';
                
                const isApproved = Math.random() > 0.3; // 70% chance approval
                if (isApproved) {
                    document.getElementById('successResult').style.display = 'block';
                    document.getElementById('confidenceScore').textContent = '92%';
                    document.getElementById('approvedAmount').textContent = '5,000';
                    document.getElementById('transactionId').textContent = 
                        '0x' + Math.random().toString(16).substr(2, 10) + '...' + Math.random().toString(16).substr(2, 4);
                } else {
                    document.getElementById('errorResult').style.display = 'block';
                    document.getElementById('errorMessage').textContent = 
                        'AI verification failed. Please ensure photos are clear and GPS coordinates are accurate.';
                }
            }, 2000);
        });
    </script>
</body>
</html>                <option value="completion">Project Completion</option>
            </select>
            <textarea id="evidence" placeholder="Describe work completed or paste photo URLs..." rows="4" required></textarea>
            <button type="submit">Submit for AI Review</button>
        </form>
        <div id="result"></div>
    </div>

    <!-- Milestone Status -->
    <div class="container">
        <h3>Milestone Status</h3>
        <div class="approved">
            <h4>‚úÖ Site Preparation - $5,000</h4>
            <p>Paid: Oct 15, 2024 | TX: mock_tx_RD-2024-001_site_prep</p>
        </div>
        <div class="approved">
            <h4>‚úÖ Foundation Work - $10,000</h4>
            <p>Paid: Oct 25, 2024 | TX: mock_tx_RD-2024-001_foundation</p>
        </div>
        <div class="pending">
            <h4>üîÑ Road Paving - $15,000</h4>
            <p>Status: Awaiting AI Review</p>
        </div>
    </div>

    <!-- Transaction History -->
    <div class="container">
        <h3>Payment History</h3>
        <table id="paymentTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Milestone</th>
                    <th>Amount</th>
                    <th>Transaction ID</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>2024-10-15</td><td>Site Preparation</td><td>$5,000</td><td>mock_tx_001</td><td>‚úÖ Paid</td></tr>
                <tr><td>2024-10-25</td><td>Foundation Work</td><td>$10,000</td><td>mock_tx_002</td><td>‚úÖ Paid</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        document.getElementById('milestoneForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('result');
            const evidence = document.getElementById('evidence').value.trim();
            const milestoneType = document.getElementById('milestoneType').value;

            if (!milestoneType) {
                alert('Please select a milestone type.');
                return;
            }

            resultDiv.innerHTML = '<div class="pending"><p>üîÑ AI is analyzing your evidence...</p></div>';

            // Simulate AI analysis delay
            setTimeout(() => {
                if (evidence.length > 10) {
                    const confidence = (Math.random() * (95 - 75) + 75).toFixed(2);
                    resultDiv.innerHTML = `
                        <div class="approved">
                            <h3>‚úÖ PAYMENT APPROVED</h3>
                            <p><strong>Milestone:</strong> ${milestoneType.replace('_', ' ')}</p>
                            <p><strong>Amount:</strong> $15,000</p>
                            <p><strong>AI Confidence:</strong> ${confidence}%</p>
                            <p><strong>Reason:</strong> Evidence verified as completed milestone with adequate proof.</p>
                            <button onclick="executePayment(15000, '${milestoneType}')">Execute USDC Payment</button>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="denied">
                            <h3>‚ùå APPROVAL DENIED</h3>
                            <p><strong>Reason:</strong> Insufficient evidence provided. Please include photos or detailed descriptions.</p>
                        </div>
                    `;
                }
            }, 2000);
        });

        function executePayment(amount, milestone) {
            const table = document.querySelector("#paymentTable tbody");
            const date = new Date().toISOString().split('T')[0];
            const txId = `mock_tx_${Date.now()}`;

            // Append new row to payment history
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${date}</td>
                <td>${milestone.replace('_', ' ')}</td>
                <td>$${amount}</td>
                <td>${txId}</td>
                <td>‚úÖ Paid</td>
            `;
            table.appendChild(row);

            alert(`üí∞ Payment of $${amount} executed!\nTransaction ID: ${txId}`);

            // TODO: Replace mock payment with actual USDC on-chain logic
        }
    </script>
</body>
</html>
